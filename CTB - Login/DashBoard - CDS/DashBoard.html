<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GeoSegBar — Dashboard</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">

    <!-- Chart.js e Leaflet -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg: #0b1220;
            --panel: #0f1720aa;
            --glass: rgba(255, 255, 255, 0.04);
            --accent: #00b8ea;
            --accent-2: #006fbe;
            --muted: #b8c6d1;
            --white: #ffffff;
            --card-radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        ::-webkit-scrollbar {
            width: 2px;
        }

        /* trilho (fundo da barra) */
        ::-webkit-scrollbar-track {
            background: #ffffff;
            border-radius: 10px;
        }

        /* polegar (parte que desliza) */
        ::-webkit-scrollbar-thumb {
            background: #002c4b;
            border-radius: 10px;
        }

        /* quando passa o mouse */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, Segoe UI, Roboto;
            background: linear-gradient(180deg, #07111a 0%, #061018 100%);
            color: var(--muted);
            min-height: 100vh
        }

        .layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 24px;
            padding: 28px;
            align-items: start
        }

        /* SIDEBAR */
        .sidebar {
            background: var(--panel);
            padding: 18px;
            border-radius: 14px;
            border: 1px solid var(--glass);
            height: calc(100vh - 56px);
            overflow: auto;
            padding-bottom: 28px;
            /* espaço extra para evitar corte */
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 18px
        }

        .brand .logo {
            width: 52px;
            height: 52px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 20px
        }

        .brand .info {
            font-weight: 700;
            color: var(--white)
        }

        .nav {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .nav button {
            background: transparent;
            border: 0;
            color: var(--muted);
            padding: 10px;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            font-weight: 600;
            transition: background .18s ease, color .18s ease, transform .12s ease, box-shadow .18s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .nav button:hover {
            transform: translateY(-2px);
        }

        .nav button.active,
        .nav button:hover {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: #04202b;
            box-shadow: 0 8px 26px rgba(0, 0, 0, 0.45)
        }

        /* usuário: área compacta e fixa no topo da sidebar (não estoura e permite wrap do email) */
        .user {
            margin-top: 12px;
            padding: 10px;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(0, 0, 0, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.02);
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 18px;
            /* fica mais "acima" na sidebar */
            z-index: 6;
            min-width: 0;
            /* permite que os filhos encolham corretamente */
            overflow: hidden;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: #0b67a9;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex: 0 0 44px;
        }

        /* texto do usuário: evitar overflow e permitir quebra inteligente / truncar quando necessário */
        .user>div {
            min-width: 0;
            overflow: hidden;
        }

        #user_email {
            font-weight: 700;
            color: var(--white);
            font-size: 13px;
            overflow-wrap: anywhere;
            word-break: break-word;
            white-space: normal;
            margin-bottom: 2px;
            display: block;
        }

        #user_role {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        /* MAIN */
        .main {
            padding-right: 18px
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px
        }

        .kpis {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            flex-wrap: wrap
        }

        .kpi {
            flex: 1 1 220px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--glass);
            box-shadow: 0 8px 30px rgba(2, 132, 199, 0.06)
        }

        .kpi h3 {
            margin: 0;
            font-size: 13px;
            color: var(--muted)
        }

        .kpi .value {
            font-size: 22px;
            color: var(--white);
            font-weight: 800;
            margin-top: 8px
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 18px
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--glass)
        }

        #map {
            height: 360px;
            border-radius: 10px
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px
        }

        .table th,
        .table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 13px;
            color: var(--muted)
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        footer {
            margin-top: 18px;
            color: rgba(255, 255, 255, 0.45);
            font-size: 13px
        }

        /* Inputs / form styling for Gerenciamento rápido */
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 13px
        }

        .form-label {
            color: var(--muted);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .form-input {
            height: 44px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.02));
            color: var(--white);
            outline: none;
            font-size: 14px;
            transition: box-shadow .18s, transform .08s, border-color .12s;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02), 0 6px 18px rgba(2, 132, 199, 0.03);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.45)
        }

        .form-input:focus {
            border-color: var(--accent-2);
            box-shadow: 0 8px 30px rgba(0, 113, 190, 0.12), 0 0 0 4px rgba(0, 184, 234, 0.06);
            transform: translateY(-1px)
        }

        .form-select {
            height: 44px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: transparent;
            color: var(--white);
            outline: none;
            font-size: 14px;
            appearance: none;
            background-image: linear-gradient(45deg, transparent 50%, rgba(255, 255, 255, 0.06) 50%), linear-gradient(135deg, rgba(255, 255, 255, 0.06) 50%, transparent 50%);
            background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
            background-size: 8px 8px, 8px 8px;
            background-repeat: no-repeat;
        }

        .form-row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .form-row .form-field {
            flex: 1
        }

        .btn-primary {
            padding: 10px 12px;
            border-radius: 10px;
            border: 0;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: #04202b;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(2, 132, 199, 0.12);
            transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 40px rgba(2, 132, 199, 0.16);
            opacity: 0.98;
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(.998);
            box-shadow: 0 12px 30px rgba(2, 132, 199, 0.12);
        }

        .btn-ghost {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: background .12s ease, transform .12s ease, color .12s ease, border-color .12s ease;
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.01);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.08);
            color: var(--white);
        }

        /* Text style fixes for consistent rendering */
        h3,
        h4,
        .headline,
        .brand .info {
            letter-spacing: 0.2px;
            -webkit-font-smoothing: antialiased;
            color: var(--white)
        }

        .small,
        .table th,
        .table td,
        .form-label {
            color: var(--muted);
        }

        /* ensure form input focus outline is smooth */
        .form-input:focus,
        .form-select:focus {
            outline: none;
            box-shadow: 0 10px 30px rgba(0, 113, 190, 0.10);
        }

        /* compact helper text */
        .help {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.45);
            margin-top: 6px
        }

        /* ensure inputs inside small card look integrated */
        .card .form-field .form-input,
        .card .form-field .form-select {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.015), rgba(0, 0, 0, 0.02));
        }

        @media(max-width:1000px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <aside class="sidebar" role="navigation" aria-label="Principal">
            <div class="brand">
                <div class="logo">GSB</div>
                <div>
                    <div class="info">GeoSegBar</div>
                    <div class="small">Segurança de Barragens</div>
                </div>
            </div>

            <nav class="nav" aria-label="Navegação">
                <button id="nav_overview" class="active" onclick="showSection('overview')">Visão Geral</button>
                <button id="nav_monitor" onclick="showSection('monitor')">Monitoramento</button>
                <button id="nav_analytics" onclick="showSection('analytics')">Análises</button>
                <button id="nav_reports" onclick="showSection('reports')">Relatórios</button>
                <button id="nav_settings" onclick="showSection('settings')">Configurações</button>
            </nav>

            <div class="user">
                <div class="avatar" id="avatar">G</div>
                <div>
                    <div id="user_email" style="font-weight:700;color:var(--white)">Usuário</div>
                    <div class="small" id="user_role">Operador</div>
                </div>
                <button class="logout" onclick="logout()">Sair</button>
            </div>
        </aside>

        <main class="main" role="main">
            <div class="topbar">
                <div>
                    <h1 style="margin:0;color:var(--white)">Painel de Controle — Segurança de Barragens</h1>
                    <div class="small">Monitoramento em tempo real, alertas e relatórios</div>
                </div>
                <div class="small">Última atualização: <span id="last_update">—</span></div>
            </div>

            <!-- Overview -->
            <section id="overview_section">
                <div class="kpis">
                    <div class="kpi card">
                        <h3>Estado geral</h3>
                        <div class="value" id="kpi_status">Estável</div>
                        <div class="small">Barragens com risco alto: <strong id="kpi_high">2</strong></div>
                    </div>
                    <div class="kpi card">
                        <h3>Incidentes (30d)</h3>
                        <div class="value" id="kpi_incidents">4</div>
                        <div class="small">Alertas novos: <strong id="kpi_alerts">1</strong></div>
                    </div>
                    <div class="kpi card">
                        <h3>Vazão atual</h3>
                        <div class="value" id="kpi_flow">1,240 m³/s</div>
                        <div class="small">Nível médio: <strong id="kpi_level">78%</strong></div>
                    </div>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3 style="color:var(--white)">Mapa e monitoramento</h3>
                        <div id="map"></div>
                        <div style="display:flex;gap:8px;margin-top:10px">
                            <select id="select_site" onchange="focusSite(this.value)">
                                <option value="all">Todos os pontos</option>
                                <option value="site1">Barragem A</option>
                                <option value="site2">Barragem B</option>
                                <option value="site3">Barragem C</option>
                            </select>
                            <button onclick="simulateAlert()"
                                style="margin-left:auto;padding:8px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#04202b;cursor:pointer">Simular
                                Alerta</button>
                        </div>

                        <!-- Gerenciamento rápido: adicionar ponto e leituras -->
                        <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
                            <!-- add site card -->
                            <div style="flex:1;min-width:260px" class="card">
                                <h4 style="margin:6px 0;color:var(--white)">Adicionar novo ponto</h4>
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div class="form-field">
                                        <label class="form-label">Nome</label>
                                        <input id="new_name" class="form-input"
                                            placeholder="Barragem D — exemplo: Usina Azul" />
                                    </div>
                                    <div class="form-row">
                                        <div class="form-field">
                                            <label class="form-label">Latitude</label>
                                            <input id="new_lat" class="form-input" placeholder="-23.5000" />
                                        </div>
                                        <div class="form-field">
                                            <label class="form-label">Longitude</label>
                                            <input id="new_lng" class="form-input" placeholder="-46.6000" />
                                        </div>
                                    </div>
                                    <div class="form-field">
                                        <label class="form-label">Nível inicial (%)</label>
                                        <input id="new_level" class="form-input" placeholder="Ex: 78" />
                                        <div class="help">Informe o nível atual do reservatório em porcentagem.</div>
                                    </div>
                                    <div style="display:flex;gap:8px">
                                        <button onclick="addSiteFromForm()" class="btn-primary" style="flex:1">Adicionar
                                            ponto</button>
                                        <button onclick="clearSiteForm()" class="btn-ghost"
                                            style="flex:1">Limpar</button>
                                    </div>
                                </div>
                            </div>
                            <div style="width:320px" class="card">
                                <h4 style="margin:6px 0;color:var(--white)">Adicionar leitura</h4>
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div class="form-field">
                                        <label class="form-label">Ponto</label>
                                        <select id="read_site" class="form-select">
                                            <option value="">Escolha um ponto</option>
                                        </select>
                                    </div>
                                    <div class="form-field">
                                        <label class="form-label">Nível (%)</label>
                                        <input id="read_level" class="form-input" placeholder="Ex: 84" />
                                    </div>
                                    <div class="form-field">
                                        <label class="form-label">Timestamp (opcional)</label>
                                        <input id="read_time" class="form-input"
                                            placeholder="yyyy-mm-dd hh:mm — se vazio usará agora" />
                                    </div>
                                    <div style="display:flex;gap:8px">
                                        <button onclick="addReadingFromForm()" class="btn-primary"
                                            style="flex:1">Adicionar leitura</button>
                                        <button onclick="clearReadingForm()" class="btn-ghost"
                                            style="flex:1">Limpar</button>
                                    </div>
                                </div>
                            </div>
                            <!-- /Gerenciamento rápido -->
                        </div>

                        <div class="card">
                            <h3 style="color:var(--white)">Níveis e medidores</h3>
                            <canvas id="chartLevels" style="width:100%;height:260px"></canvas>
                            <div style="margin-top:8px" class="small">Últimas leituras de sensores</div>
                        </div>
                    </div>

                    <div style="display:flex;gap:18px;margin-top:18px;flex-wrap:wrap">
                        <div class="card" style="flex:1;min-width:320px">
                            <h3 style="color:var(--white)">Tendência de alertas</h3>
                            <canvas id="chartAlerts" style="width:100%;height:160px"></canvas>
                        </div>

                        <div class="card" style="width:420px">
                            <h3 style="color:var(--white)">Últimos eventos</h3>
                            <table class="table" aria-live="polite">
                                <thead>
                                    <tr>
                                        <th>Horário</th>
                                        <th>Local</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="events_table">
                                    <!-- preenchido por JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
            </section>

            <!-- Placeholder sections -->
            <section id="monitor_section" style="display:none">
                <div class="card">
                    <h3 style="color:var(--white)">Monitoramento Detalhado</h3>
                    <p class="small">Painel com sensores, séries temporais e logs.</p>
                </div>
            </section>

            <section id="analytics_section" style="display:none">
                <div class="card">
                    <h3 style="color:var(--white)">Análises e Modelos</h3>
                    <p class="small">Análises preditivas e simulações hidrodinâmicas.</p>
                </div>
            </section>

            <section id="reports_section" style="display:none">
                <div class="card">
                    <h3 style="color:var(--white)">Relatórios</h3>
                    <p class="small">Gerar PDF, exportar dados e histórico.</p>
                </div>
            </section>

            <section id="settings_section" style="display:none">
                <div class="card">
                    <h3 style="color:var(--white)">Configurações</h3>
                    <p class="small">Preferências do sistema, usuários e integrações.</p>
                </div>

                <!-- Gestão de funcionários -->
                <div class="card" style="margin-top:12px">
                    <h3 style="color:var(--white);margin-bottom:8px">Gestão de funcionários</h3>

                    <!-- Formulário de adição -->
                    <div style="display:flex;gap:12px;flex-wrap:wrap">
                        <div style="flex:1;min-width:320px">
                            <div class="form-field">
                                <label class="form-label">Nome</label>
                                <input id="emp_name" class="form-input" placeholder="Nome completo" />
                            </div>
                            <div class="form-row" style="margin-top:6px">
                                <div class="form-field" style="flex:1">
                                    <label class="form-label">Email</label>
                                    <input id="emp_email" class="form-input" placeholder="usuario@empresa.com" />
                                </div>
                                <div class="form-field" style="width:160px">
                                    <label class="form-label">Cargo</label>
                                    <select id="emp_role" class="form-select">
                                        <option value="Operador">Operador</option>
                                        <option value="Engenheiro">Engenheiro</option>
                                        <option value="Supervisor">Supervisor</option>
                                        <option value="Gestor">Gestor</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-field" style="margin-top:8px">
                                <label class="form-label">Tags de autoridade</label>
                                <div style="display:flex;gap:8px;flex-wrap:wrap">
                                    <label style="display:inline-flex;align-items:center;gap:8px">
                                        <input type="checkbox" class="emp-tag" value="Defesa Civil" /> Defesa Civil
                                    </label>
                                    <label style="display:inline-flex;align-items:center;gap:8px">
                                        <input type="checkbox" class="emp-tag" value="Autoridade Ambiental" />
                                        Autoridade Ambiental
                                    </label>
                                    <label style="display:inline-flex;align-items:center;gap:8px">
                                        <input type="checkbox" class="emp-tag" value="Prefeitura" /> Prefeitura
                                    </label>
                                    <label style="display:inline-flex;align-items:center;gap:8px">
                                        <input type="checkbox" class="emp-tag" value="Proteção" /> Proteção
                                    </label>
                                </div>
                                <div class="help">Marque as tags que esse funcionário possui.</div>
                            </div>

                            <div style="display:flex;gap:8px;margin-top:8px">
                                <button onclick="addEmployeeFromForm()" class="btn-primary" style="flex:1">Adicionar
                                    funcionário</button>
                                <button onclick="clearEmployeeForm()" class="btn-ghost" style="flex:1">Limpar</button>
                            </div>
                        </div>

                        <!-- Tabela de funcionários -->
                        <div style="flex:1;min-width:420px">
                            <h4 style="margin:6px 0;color:var(--white)">Funcionários</h4>
                            <table class="table" id="employees_table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Cargo</th>
                                        <th>Tags</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <div class="help" style="margin-top:8px">As alterações ficam salvas localmente
                                (localStorage).</div>
                        </div>
                    </div>
                </div>
            </section>

            <footer><small>© GeoSegBar — Painel de Monitoramento</small></footer>
        </main>
    </div>

    <script>
        // inicialização do usuário (vindo do login)
        const user = JSON.parse(sessionStorage.getItem('gsb_user') || '{}');
        if (!user.email) {
            // se não autenticado, volta ao login
            setTimeout(() => location.href = 'SegBar.html', 80);
        } else {
            document.getElementById('user_email').textContent = user.email;
            document.getElementById('avatar').textContent = user.email.charAt(0).toUpperCase();
        }

        function logout() {
            sessionStorage.removeItem('gsb_user');
            location.href = 'SegBar.html';
        }

        function showSection(key) {
            // nav highlights
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('nav_' + (key === 'overview' ? 'overview' : key)).classList.add('active');
            // sections display
            document.getElementById('overview_section').style.display = key === 'overview' ? '' : 'none';
            document.getElementById('monitor_section').style.display = key === 'monitor' ? '' : 'none';
            document.getElementById('analytics_section').style.display = key === 'analytics' ? '' : 'none';
            document.getElementById('reports_section').style.display = key === 'reports' ? '' : 'none';
            document.getElementById('settings_section').style.display = key === 'settings' ? '' : 'none';
        }

        // LAST UPDATE
        function updateTimestamp() { document.getElementById('last_update').textContent = new Date().toLocaleString(); }
        updateTimestamp(); setInterval(updateTimestamp, 30_000);

        // MAP: initialize map with Ctrl+wheel zoom behavior and no predefined markers
        const map = L.map('map', { scrollWheelZoom: false }).setView([-14.2350, -51.9253], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);

        // Global flag: disable all automatic/manual readings & hide reading UI when false
        const SHOW_READINGS = false;

        // Ensure any leftover auto intervals are cleared
        if (window.autoReadIntervalId) {
            clearInterval(window.autoReadIntervalId);
            window.autoReadIntervalId = null;
        }

        // If readings are disabled, hide charts and events and disable read form controls
        (function disableReadingsUIIfNeeded() {
            if (SHOW_READINGS) return;
            // hide charts canvases and their parent cards (if present)
            const levelsCanvas = document.getElementById('chartLevels');
            if (levelsCanvas) {
                const parent = levelsCanvas.closest('.card');
                if (parent) parent.style.display = 'none';
            }
            const alertsCanvas = document.getElementById('chartAlerts');
            if (alertsCanvas) {
                const parent = alertsCanvas.closest('.card');
                if (parent) parent.style.display = 'none';
            }
            // hide events card/table
            const eventsTable = document.getElementById('events_table');
            if (eventsTable) {
                const card = eventsTable.closest('.card');
                if (card) card.style.display = 'none';
                eventsTable.innerHTML = ''; // clear any previous rows
            }
            // disable reading form controls & buttons
            const readSite = document.getElementById('read_site');
            const readLevel = document.getElementById('read_level');
            const readTime = document.getElementById('read_time');
            if (readSite) readSite.disabled = true;
            if (readLevel) { readLevel.disabled = true; readLevel.value = ''; }
            if (readTime) { readTime.disabled = true; readTime.value = ''; }
            // disable add reading button(s)
            document.querySelectorAll('button').forEach(b => {
                const txt = (b.textContent || '').trim().toLowerCase();
                if (txt.includes('adicionar leitura') || (b.getAttribute('onclick') || '').includes('addReadingFromForm')) {
                    b.disabled = true;
                    b.style.opacity = '0.6';
                    b.title = 'Leituras desabilitadas';
                }
            });
        })();

        // focus site helper — handles empty lists safely
        function focusSite(id) {
            if (id === 'all') {
                const coords = Object.values(sites).map(s => s.coords);
                if (coords.length) map.fitBounds(coords, { padding: [40, 40] });
                return;
            }
            const s = sites[id];
            if (!s) return;
            map.setView(s.coords, 13, { animate: true });
            if (markers[id]) markers[id].openPopup();
        }

        // simulateAlert: guard for marker existence (no assumptions about pre-existing markers)
        function simulateAlert() {
            const now = new Date().toLocaleString();
            const ev = { time: now, place: '—', type: 'Nível alto', status: 'Novo' };
            const tbodyEl = document.getElementById('events_table');
            if (tbodyEl) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="color:var(--white)">${ev.time}</td><td>${ev.place}</td><td>${ev.type}</td><td style="color:#ffb86b">${ev.status}</td>`;
                tbodyEl.prepend(tr);
            }
            const kpiAlertsEl = document.getElementById('kpi_alerts');
            const kpiIncidentsEl = document.getElementById('kpi_incidents');
            if (kpiAlertsEl) kpiAlertsEl.textContent = String(parseInt(kpiAlertsEl.textContent || '0', 10) + 1);
            if (kpiIncidentsEl) kpiIncidentsEl.textContent = String(parseInt(kpiIncidentsEl.textContent || '0', 10) + 1);

            // optional marker highlight
            if (markers['site2']) {
                markers['site2'].setStyle({ color: 'red', fillColor: 'red' });
                markers['site2'].openPopup();
            }
            updateTimestamp();
        }

        // atualizações periódicas simuladas (atualiza últimos valores)
        setInterval(() => {
            const newVal = (1200 + Math.round(Math.random() * 400));
            const kpiFlow = document.getElementById('kpi_flow');
            if (kpiFlow) kpiFlow.textContent = newVal.toLocaleString() + ' m³/s';
            const lvl = (70 + Math.round(Math.random() * 20));
            const kpiLevel = document.getElementById('kpi_level');
            if (kpiLevel) kpiLevel.textContent = lvl + '%';
        }, 12_000);

        // ---------- Controlled periodic readings (disabled) ----------
        if (window.autoReadIntervalId) {
            clearInterval(window.autoReadIntervalId);
            window.autoReadIntervalId = null;
        }
        window.autoReadIntervalId = null;
        function startPeriodicReadings() {
            console.log('Automatic periodic readings are disabled.');
            // no-op
        }
        function stopPeriodicReadings() {
            if (window.autoReadIntervalId) {
                clearInterval(window.autoReadIntervalId);
                window.autoReadIntervalId = null;
            }
        }
        function periodicReadings() { return; }
        // ---------- END OF CONTROLLED READINGS ----------

        // core helper: insert a reading programmatically (used by form and scheduler)
        // If SHOW_READINGS is false this function will not update charts or show readings.
        function insertReading(siteId, level, ts = new Date(), options = {}) {
            if (!SHOW_READINGS) {
                // still update model level and marker color silently, but do not show readings, charts or events
                if (sites[siteId]) sites[siteId].level = level;
                const color = level > 85 ? '#ff4b4b' : (level > 75 ? '#ffb86b' : '#10b981');
                if (markers[siteId]) {
                    markers[siteId].setStyle({ color: color, fillColor: color });
                    markers[siteId].bindPopup(`<strong>${sites[siteId].name}</strong><br>Nível: ${level}%`);
                }
                return;
            }

            // ensure charts exist and datasets match
            createChartsIfNeeded();
            syncDatasetsWithSites();

            const MAX_POINTS = 12;
            const label = (ts instanceof Date) ? ts.toLocaleTimeString() : (new Date(ts)).toLocaleTimeString();

            // push new time label and keep sliding window
            const labels = window.levelsChart.data.labels;
            labels.push(label);
            if (labels.length > MAX_POINTS) labels.shift();

            // update every dataset: push level for this site, repeat last value for others
            const siteName = sites[siteId] ? sites[siteId].name : null;
            window.levelsChart.data.datasets.forEach(ds => {
                if (ds.label === siteName) ds.data.push(level);
                else {
                    const last = ds.data.length ? ds.data[ds.data.length - 1] : 0;
                    ds.data.push(last);
                }
                if (ds.data.length > MAX_POINTS) ds.data.shift();
            });
            window.levelsChart.update();

            // alerts chart: record 1 if >85 else 0
            const isAlert = level > 85 ? 1 : 0;
            window.alertsChart.data.labels.push(label);
            window.alertsChart.data.datasets[0].data.push(isAlert);
            if (window.alertsChart.data.labels.length > MAX_POINTS) {
                window.alertsChart.data.labels.shift();
                window.alertsChart.data.datasets[0].data.shift();
            }
            window.alertsChart.update();

            // update data model and marker
            if (sites[siteId]) sites[siteId].level = level;
            const color = level > 85 ? '#ff4b4b' : (level > 75 ? '#ffb86b' : '#10b981');
            if (markers[siteId]) {
                markers[siteId].setStyle({ color: color, fillColor: color });
                markers[siteId].bindPopup(`<strong>${sites[siteId].name}</strong><br>Nível: ${level}%`);
            }

            // add event row unless silent (only if readings visible)
            if (SHOW_READINGS && !options.silent) {
                const tbodyEl = document.getElementById('events_table');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="color:var(--white)">${(ts instanceof Date ? ts : new Date(ts)).toLocaleString()}</td><td>${sites[siteId] ? sites[siteId].name : '—'}</td><td>Leitura</td><td style="color:${isAlert ? '#ff4b4b' : '#10b981'}">${isAlert ? 'Alerta' : 'OK'}</td>`;
                if (tbodyEl) tbodyEl.prepend(tr);
            }

            // update KPI count for alerts only when readings shown
            if (SHOW_READINGS && isAlert) {
                const el = document.getElementById('kpi_alerts');
                if (el) el.textContent = String(parseInt(el.textContent || '0', 10) + 1);
            }

            updateTimestamp();
        }
    </script>
    <script>
        /* Safety: define helpers only if they don't already exist to avoid duplication errors */
        if (typeof createChartsIfNeeded === 'undefined') {
            function createChartsIfNeeded() {
                // guard DOM
                const levelsCanvas = document.getElementById('chartLevels');
                const alertsCanvas = document.getElementById('chartAlerts');
                if (!levelsCanvas || !alertsCanvas) return;

                // create levels chart if missing
                if (typeof window.levelsChart === 'undefined') {
                    const ctx = levelsCanvas.getContext('2d');
                    window.levelsChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: {
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: 'rgba(255,255,255,0.85)' } } },
                            scales: {
                                x: { ticks: { color: 'rgba(255,255,255,0.6)' } },
                                y: { ticks: { color: 'rgba(255,255,255,0.6)' }, beginAtZero: true, suggestedMax: 100 }
                            },
                            animation: { duration: 260 }
                        }
                    });
                }

                // create alerts chart if missing
                if (typeof window.alertsChart === 'undefined') {
                    const ctxA = alertsCanvas.getContext('2d');
                    window.alertsChart = new Chart(ctxA, {
                        type: 'bar',
                        data: { labels: [], datasets: [{ label: 'Alertas', data: [], backgroundColor: 'rgba(255,99,71,0.9)' }] },
                        options: {
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: 'rgba(255,255,255,0.6)' } },
                                y: { ticks: { color: 'rgba(255,255,255,0.6)' }, beginAtZero: true, suggestedMax: 3 }
                            },
                            animation: { duration: 260 }
                        }
                    });
                }
            }
        }

        if (typeof syncDatasetsWithSites === 'undefined') {
            function syncDatasetsWithSites() {
                createChartsIfNeeded();
                if (!window.levelsChart) return;
                const MAX_POINTS = 12;
                const labels = window.levelsChart.data.labels;
                const palette = ['#f97316', '#10b981', '#a78bfa', '#60a5fa', '#ef4444', '#f43f5e'];
                const existing = window.levelsChart.data.datasets.map(d => d.label);

                // add missing datasets
                Object.keys(sites).forEach((id) => {
                    const name = sites[id].name;
                    if (!existing.includes(name)) {
                        const arr = labels.map(() => 0);
                        if (labels.length) arr[arr.length - 1] = sites[id].level || 0;
                        const colorPick = palette[window.levelsChart.data.datasets.length % palette.length];
                        window.levelsChart.data.datasets.push({
                            label: name,
                            data: arr,
                            borderColor: colorPick,
                            backgroundColor: hexToRgba(colorPick, 0.06),
                            tension: 0.3,
                            pointRadius: 3
                        });
                    }
                });

                // remove datasets for deleted sites
                window.levelsChart.data.datasets = window.levelsChart.data.datasets.filter(ds => {
                    return Object.values(sites).some(s => s.name === ds.label);
                });

                // ensure dataset lengths match labels
                window.levelsChart.data.datasets.forEach(ds => {
                    while (ds.data.length < labels.length) ds.data.unshift(0);
                    while (ds.data.length > labels.length) ds.data.shift();
                    if (ds.data.length > MAX_POINTS) ds.data = ds.data.slice(-MAX_POINTS);
                });

                window.levelsChart.update();
            }
        }

        /* Clear form helpers (ensure exist) */
        if (typeof clearSiteForm === 'undefined') {
            function clearSiteForm() {
                const ids = ['new_name', 'new_lat', 'new_lng', 'new_level'];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                const first = document.getElementById('new_name');
                if (first) first.focus();
            }
        }

        if (typeof clearReadingForm === 'undefined') {
            function clearReadingForm() {
                const readSel = document.getElementById('read_site');
                if (readSel) readSel.value = '';
                ['read_level', 'read_time'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            }
        }

        /* Ensure updateSiteSelectors exists and updates both selects and charts */
        if (typeof updateSiteSelectors === 'undefined') {
            function updateSiteSelectors() {
                const select = document.getElementById('select_site');
                const readSel = document.getElementById('read_site');
                if (!select || !readSel) return;
                // preserve currently selected values when possible
                const prevSel = select.value;
                const prevRead = readSel.value;

                select.innerHTML = '<option value="all">Todos os pontos</option>';
                readSel.innerHTML = '<option value="">Escolha um ponto</option>';

                Object.keys(sites).forEach(id => {
                    const opt = document.createElement('option');
                    opt.value = id; opt.textContent = sites[id].name;
                    select.appendChild(opt);
                    const opt2 = opt.cloneNode(true);
                    readSel.appendChild(opt2);
                });

                // restore if still valid
                if (prevSel && Array.from(select.options).some(o => o.value === prevSel)) select.value = prevSel;
                if (prevRead && Array.from(readSel.options).some(o => o.value === prevRead)) readSel.value = prevRead;

                // ensure charts exist and datasets sync
                createChartsIfNeeded();
                syncDatasetsWithSites();
            }
        }

        /* Make sure addSiteFromForm inserts dataset + updates selectors and charts */
        if (typeof addSiteFromForm === 'undefined') {
            function addSiteFromForm() {
                const name = document.getElementById('new_name').value.trim();
                const latRaw = document.getElementById('new_lat').value.trim();
                const lngRaw = document.getElementById('new_lng').value.trim();
                const levelRaw = document.getElementById('new_level').value.trim();
                const lat = parseFloat(latRaw.replace(',', '.'));
                const lng = parseFloat(lngRaw.replace(',', '.'));
                const level = Number(levelRaw);

                if (!name) { alert('Nome é obrigatório.'); return; }
                if (isNaN(lat) || lat < -90 || lat > 90) { alert('Latitude inválida.'); return; }
                if (isNaN(lng) || lng < -180 || lng > 180) { alert('Longitude inválida.'); return; }
                if (isNaN(level) || level < 0 || level > 9999) { alert('Nível inválido.'); return; }

                const id = 'site' + Date.now();
                sites[id] = { name, coords: [lat, lng], level };

                const color = level > 85 ? '#ff4b4b' : (level > 75 ? '#ffb86b' : '#10b981');
                const marker = L.circleMarker([lat, lng], { radius: 10, color, fillColor: color, fillOpacity: 0.9, weight: 1.5 })
                    .addTo(map)
                    .bindPopup(`<strong>${name}</strong><br>Nível: ${level}%`);
                markers[id] = marker;

                // update selectors and charts
                updateSiteSelectors();

                // immediately select the newly added site in the read selector
                const readSel = document.getElementById('read_site');
                const selectAll = document.getElementById('select_site');
                if (readSel) { readSel.value = id; readSel.dispatchEvent(new Event('change', { bubbles: true })); }
                if (selectAll) { selectAll.value = id; selectAll.dispatchEvent(new Event('change', { bubbles: true })); }

                // add dataset if charts exist
                createChartsIfNeeded();
                syncDatasetsWithSites();

                // add event row
                const tbody = document.getElementById('events_table');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="color:var(--white)">${new Date().toLocaleString()}</td><td>${name}</td><td>Cadastro</td><td style="color:#10b981">Criado</td>`;
                tbody.prepend(tr);

                map.setView([lat, lng], 12, { animate: true });
                marker.openPopup();
                // automatic periodic readings are disabled (charts remain static until user adds leituras manualmente)
                clearSiteForm();
            }
        }

        /* Ensure addReadingFromForm uses insertReading helper (exists earlier). If not, create fallback */
        if (typeof addReadingFromForm === 'undefined') {
            function addReadingFromForm() {
                const siteId = document.getElementById('read_site').value;
                const level = Number(document.getElementById('read_level').value);
                const timeInput = document.getElementById('read_time').value.trim();
                if (!siteId || isNaN(level)) { alert('Escolha um ponto e informe um nível válido.'); return; }
                const ts = timeInput ? new Date(timeInput) : new Date();
                if (isNaN(ts)) { alert('Timestamp inválido.'); return; }
                if (typeof insertReading === 'function') {
                    insertReading(siteId, level, ts, { silent: false });
                } else {
                    // minimal fallback: push into charts directly
                    createChartsIfNeeded();
                    syncDatasetsWithSites();
                    insertReading(siteId, level, ts, { silent: false });
                }
                clearReadingForm();
            }
        }

        /* Ensure all top-level buttons have handlers (attach safe listeners) */
        document.addEventListener('DOMContentLoaded', () => {
            // nav already uses inline onclick, but ensure keyboard-friendly activation
            document.querySelectorAll('.nav button').forEach(b => {
                b.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') b.click(); });
            });

            // hook primary form buttons if inline handlers are missing
            const addSiteBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent && btn.textContent.replace(/\s+/g, '').includes('Adicionarponto'));
            if (!addSiteBtn) {
                const fallback = document.querySelector('button[onclick*="addSiteFromForm"]');
                if (fallback) fallback.addEventListener('click', addSiteFromForm);
            }

            const addReadBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent && btn.textContent.replace(/\s+/g, '').includes('Adicionarleitura'));
            if (!addReadBtn) {
                const fallback = document.querySelector('button[onclick*="addReadingFromForm"]');
                if (fallback) fallback.addEventListener('click', addReadingFromForm);
            }

            // Cancel / clear buttons
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent && btn.textContent.trim().toLowerCase().includes('limpar')) {
                    btn.addEventListener('click', () => {
                        // try both forms
                        clearSiteForm();
                        clearReadingForm();
                    });
                }
                if (btn.textContent && btn.textContent.trim().toLowerCase().includes('cancelar')) {
                    btn.addEventListener('click', () => { location.href = 'SegBar.html'; });
                }
            });

            // ensure select_site change focuses site
            const sel = document.getElementById('select_site');
            if (sel) sel.addEventListener('change', (e) => { focusSite(e.target.value); });

            // ensure simulate alert button exists and wired
            const simBtn = Array.from(document.querySelectorAll('button')).find(b => /Simular\s*Alerta/i.test(b.textContent || ''));
            if (simBtn) simBtn.addEventListener('click', simulateAlert);

            // initialize charts and selectors now that DOM is ready
            createChartsIfNeeded();
            updateSiteSelectors();
        });
    </script>
</body>

</html>